---

title: DBCM


keywords: fastai
sidebar: home_sidebar

summary: "A Dynamic Binary Cascade Model, or DBCM, is the combination of a DCMM and a binary cascade as described in <a href='https://arxiv.org/pdf/1808.04698.pdf'>Berry, Helman, and West (2020)</a>."
description: "A Dynamic Binary Cascade Model, or DBCM, is the combination of a DCMM and a binary cascade as described in <a href='https://arxiv.org/pdf/1808.04698.pdf'>Berry, Helman, and West (2020)</a>."
nb_path: "nbs/12_dbcm.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/12_dbcm.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The DBCM is a combination of a Dynamic Count Mixture Model (DCMM) and a binary cascade of Bernoulli DGLMs. The original use case came from a retail sales settings. Consider two time series, one of transactions and the other of sales for a single item. A DCMM is used to model the number of transactions that involve the item. The binary cascade models the number of units that each shopper will purchase. The cascade is a sequence of probabilities for whether a shopper will purchase $r+1$ items, conditional on them having purchased $r$ items.</p>
<p>The first component of a DBCM is the DCMM, used to model the total number of daily transactions containing the item of interest, $b_t$. We repeat the form of a DCMM for clarity:</p>
$$
z_t \sim Ber(\pi_t) \text{ and } b_t \mid z_t =
\begin{cases}
0, &amp; \text{if } z_t = 0,\\
1 + x_t, \quad x_t \sim Po(\mu_t), &amp; \text{if }z_t = 1
\end{cases}
$$<p>where $\pi_t$ and $\mu_t$ vary according to the dynamics of independent Bernoulli and Poisson DGLMs respectively.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Transactions $b_t$ are related to sales by modeling the number of units sold in each transaction. Recognizing that sales outliers often occur due to shoppers buying many units of an item, the probability of each quantity is modeled with a binary cascade. Let $n_{r,t}$ be the number of transactions with more than $r$ units. Then $n_{r,t} | n_{r-1, t} \sim Bin(n_{r-1,t}, \pi_{r,t})$ is defined by a binomial DGLM. This cascade of binomial DGLMs represents the sequence of conditional probabilities for purchasing $r$ units or greater, given that the shopper has bought $r-1$. The sales $y_t$ are then:</p>
$$
y_t =
\begin{cases}
0, &amp; \text{if } z_t = 0,\\
\sum_{r=1:d} r(n_{r-1, t} - n_{r,t}) + e_t, &amp; \text{if }z_t = 1,
\end{cases}
$$<p>where $d$ is the predefined length of the cascade and $e_t$ represents excess units greater than $d$. The cascade enables modeling of very small probabilities, in the rare cases when shoppers purchase large quantities of an item on a single grocery store trip.</p>
<p>To model transactions with a quantity greater than $d$, we follow the "Bayesian bootstrap" strategy of <a href="https://arxiv.org/pdf/1808.04698.pdf">Berry, Helman, and West (2020)</a>, which is to record the observed outlier quantities purchased, and to forecast by sampling from the empirical distribution for the excess, $e_t$.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="dbcm" class="doc_header"><code>class</code> <code>dbcm</code><a href="https://github.com/lavinei/pybats_nbdev/tree/master/pybats_nbdev/dbcm.py#L14" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>dbcm</code>(<strong><code>a0_bern</code></strong>=<em><code>None</code></em>, <strong><code>R0_bern</code></strong>=<em><code>None</code></em>, <strong><code>nregn_bern</code></strong>=<em><code>0</code></em>, <strong><code>ntrend_bern</code></strong>=<em><code>0</code></em>, <strong><code>nlf_bern</code></strong>=<em><code>0</code></em>, <strong><code>nhol_bern</code></strong>=<em><code>0</code></em>, <strong><code>seasPeriods_bern</code></strong>=<em><code>[]</code></em>, <strong><code>seasHarmComponents_bern</code></strong>=<em><code>[]</code></em>, <strong><code>deltrend_bern</code></strong>=<em><code>1</code></em>, <strong><code>delregn_bern</code></strong>=<em><code>1</code></em>, <strong><code>delhol_bern</code></strong>=<em><code>1</code></em>, <strong><code>delseas_bern</code></strong>=<em><code>1</code></em>, <strong><code>dellf_bern</code></strong>=<em><code>1</code></em>, <strong><code>a0_pois</code></strong>=<em><code>None</code></em>, <strong><code>R0_pois</code></strong>=<em><code>None</code></em>, <strong><code>nregn_pois</code></strong>=<em><code>0</code></em>, <strong><code>ntrend_pois</code></strong>=<em><code>0</code></em>, <strong><code>nlf_pois</code></strong>=<em><code>0</code></em>, <strong><code>nhol_pois</code></strong>=<em><code>0</code></em>, <strong><code>seasPeriods_pois</code></strong>=<em><code>[]</code></em>, <strong><code>seasHarmComponents_pois</code></strong>=<em><code>[]</code></em>, <strong><code>deltrend_pois</code></strong>=<em><code>1</code></em>, <strong><code>delregn_pois</code></strong>=<em><code>1</code></em>, <strong><code>delhol_pois</code></strong>=<em><code>1</code></em>, <strong><code>delseas_pois</code></strong>=<em><code>1</code></em>, <strong><code>dellf_pois</code></strong>=<em><code>1</code></em>, <strong><code>rho</code></strong>=<em><code>1</code></em>, <strong><code>interpolate</code></strong>=<em><code>True</code></em>, <strong><code>adapt_discount</code></strong>=<em><code>False</code></em>, <strong><code>mod_dcmm</code></strong>=<em><code>None</code></em>, <strong><code>ncascade</code></strong>=<em><code>4</code></em>, <strong><code>a0_cascade</code></strong>=<em><code>None</code></em>, <strong><code>R0_cascade</code></strong>=<em><code>None</code></em>, <strong><code>nregn_cascade</code></strong>=<em><code>0</code></em>, <strong><code>ntrend_cascade</code></strong>=<em><code>0</code></em>, <strong><code>nlf_cascade</code></strong>=<em><code>0</code></em>, <strong><code>nhol_cascade</code></strong>=<em><code>0</code></em>, <strong><code>seasPeriods_cascade</code></strong>=<em><code>[]</code></em>, <strong><code>seasHarmComponents_cascade</code></strong>=<em><code>[]</code></em>, <strong><code>deltrend_cascade</code></strong>=<em><code>1</code></em>, <strong><code>delregn_cascade</code></strong>=<em><code>1</code></em>, <strong><code>delhol_cascade</code></strong>=<em><code>1</code></em>, <strong><code>delseas_cascade</code></strong>=<em><code>1</code></em>, <strong><code>dellf_cascade</code></strong>=<em><code>1</code></em>, <strong><code>excess</code></strong>=<em><code>[]</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A DBCM can be used in the same way as a DGLM, with the standard methods <a href="/pybats_nbdev/dbcm.html#dbcm.update"><code>dbcm.update</code></a>, <a href="/pybats_nbdev/dbcm.html#dbcm.forecast_marginal"><code>dbcm.forecast_marginal</code></a>, and <a href="/pybats_nbdev/dbcm.html#dbcm.forecast_path"><code>dbcm.forecast_path</code></a>. There are equivalent helper functions as well. A full analysis can be run with <a href="/pybats_nbdev/analysis.html#analysis_dbcm"><code>analysis_dbcm</code></a>, and <a href="/pybats_nbdev/define_models.html#define_dbcm"><code>define_dbcm</code></a> helps to initialize a DBCM.</p>
<p>The only difference from using a standard <a href="/pybats_nbdev/dglm.html"><code>dglm</code></a> is that outside of <a href="/pybats_nbdev/analysis.html#analysis_dbcm"><code>analysis_dbcm</code></a>, the update and forecast functions do not automatically recognize whether the DBCM includes latent factors or call a copula for path forecasting. This means that the modeler needs to be more explicit in calling the correct method, such as <a href="/pybats_nbdev/dbcm.html#dbcm.forecast_path_copula"><code>dbcm.forecast_path_copula</code></a> for path forecasting with a copula.</p>
<p>A quick example of using <a href="/pybats_nbdev/analysis.html#analysis_dbcm"><code>analysis_dbcm</code></a> follows:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pybats_nbdev.shared</span> <span class="kn">import</span> <span class="n">load_dbcm_latent_factor_example</span>
<span class="kn">from</span> <span class="nn">pybats_nbdev.analysis</span> <span class="kn">import</span> <span class="n">analysis_dbcm</span>
<span class="kn">from</span> <span class="nn">pandas.tseries.holiday</span> <span class="kn">import</span> <span class="n">USFederalHolidayCalendar</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_dbcm_latent_factor_example</span><span class="p">()[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The data has already been formatted for use in a DBCM:</p>
<ul>
<li><code>Sales</code> are the final outcome we want to model. </li>
<li><code>Y_transaction</code> is the number of transactions, which is always less than or equal to the total <code>Sales</code>.</li>
<li><code>X_transaction</code> is a predictor variable for the DCMM on transactions. In this case, it's the item price.</li>
<li><code>mt1</code> through <code>mt4</code> is the number of shoppers who purchased <em>more than r</em> units of the item.</li>
<li><code>X_cascade</code> is a predictor variable for the binary cascade. In this case it's an indicator of item promotions - such as "buy one get one free" - which would influence the quantity each shopper buys. </li>
<li><code>excess</code> is a list of unit quantities for any shoppers with 5 or more items in their cart, which extends beyond the length of the cascade, which is set to the default of $4$.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rho</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">nsamps</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">prior_length</span> <span class="o">=</span> <span class="mi">21</span>

<span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span>
<span class="n">forecast_start_date</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span>
<span class="n">forecast_end_date</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mod</span><span class="p">,</span> <span class="n">forecast_samples</span> <span class="o">=</span> <span class="n">analysis_dbcm</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_transaction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_transaction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                                 <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;mt1&#39;</span><span class="p">,</span> <span class="s1">&#39;mt2&#39;</span><span class="p">,</span> <span class="s1">&#39;mt3&#39;</span><span class="p">,</span> <span class="s1">&#39;mt4&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_cascade&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">prior_length</span><span class="o">=</span><span class="n">prior_length</span><span class="p">,</span>
                                 <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                                 <span class="n">forecast_start</span><span class="o">=</span><span class="n">forecast_start_date</span><span class="p">,</span>
                                 <span class="n">forecast_end</span><span class="o">=</span><span class="n">forecast_end_date</span><span class="p">,</span>
                                 <span class="n">nsamps</span><span class="o">=</span><span class="n">nsamps</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span>
                                 <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">,</span> <span class="n">delregn_pois</span><span class="o">=.</span><span class="mi">98</span><span class="p">,</span>
                                 <span class="n">ret</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>beginning forecasting
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The DBCM is a wrapper for the DCMM and the binary cascade. To illustrate, we can call <code>mod.forecast_marginal</code>, with two flags activated:</p>
<ul>
<li><code>mean_only=True</code>, which is available for all models in PyBATS. This returns the mean of the forecast distribution, instead of samples.</li>
<li><code>return_separate=True</code>, available only for DBCMs. This divides the forecast into the transaction, binary cascade, and excess components, returning each separately.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">transaction_mean</span><span class="p">,</span> <span class="n">cascade_mean</span><span class="p">,</span> <span class="n">excess_mean</span> <span class="o">=</span> \
<span class="n">mod</span><span class="o">.</span><span class="n">forecast_marginal</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">X_transaction</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">forecast_end_date</span><span class="p">][</span><span class="s1">&#39;X_transaction&#39;</span><span class="p">],</span>
                      <span class="n">X_cascade</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">forecast_end_date</span><span class="p">][</span><span class="s1">&#39;X_cascade&#39;</span><span class="p">],</span>
                      <span class="n">mean_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">return_separate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;sales&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transaction_mean</span> <span class="o">+</span> <span class="n">cascade_mean</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">excess_mean</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="s1">&#39;transactions&#39;</span><span class="p">:</span><span class="n">transaction_mean</span><span class="p">,</span>
                    <span class="s1">&#39;mt1&#39;</span><span class="p">:</span><span class="n">cascade_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;mt2&#39;</span><span class="p">:</span><span class="n">cascade_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;mt3&#39;</span><span class="p">:</span><span class="n">cascade_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;mt4&#39;</span><span class="p">:</span><span class="n">cascade_mean</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s1">&#39;excess&#39;</span><span class="p">:</span><span class="n">excess_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)})</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">out</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Forecast Mean&#39;</span><span class="p">]</span>
<span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Forecast Mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sales</th>
      <td>7.42</td>
    </tr>
    <tr>
      <th>transactions</th>
      <td>5.66</td>
    </tr>
    <tr>
      <th>mt1</th>
      <td>1.38</td>
    </tr>
    <tr>
      <th>mt2</th>
      <td>0.22</td>
    </tr>
    <tr>
      <th>mt3</th>
      <td>0.08</td>
    </tr>
    <tr>
      <th>mt4</th>
      <td>0.02</td>
    </tr>
    <tr>
      <th>excess</th>
      <td>0.05</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The forecast mean for item sales is $7.53$ units on $5.73$ separate transactions. On average, $1.4$ people will have more than 1 unit of the item in their basket, $0.23$ will have more than 2, and so on. Finally, the average prediction is for $0.05$ 'excess' units, which are any sales above $4$ units in a single basket.</p>

</div>
</div>
</div>
</div>
 

